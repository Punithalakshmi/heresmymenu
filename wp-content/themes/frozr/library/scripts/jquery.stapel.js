/**
 * jquery.stapel.js v1.0.0
 * http://www.codrops.com
 *
 * Licensed under the MIT license.
 * http://www.opensource.org/licenses/mit-license.php
 * 
 * Copyright 2012, Codrops
 * http://www.codrops.com
 */
!function(a,b,c){"use strict";var e,f,d=a.event;e=d.special.debouncedresize={setup:function(){a(this).on("resize",e.handler)},teardown:function(){a(this).off("resize",e.handler)},handler:function(a,b){var c=this,g=arguments,h=function(){a.type="debouncedresize",d.dispatch.apply(c,g)};f&&clearTimeout(f),b?h():f=setTimeout(h,e.threshold)},threshold:150};var g="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";a.fn.imagesLoaded=function(b){function l(){var c=a(j),f=a(k);e&&(k.length?e.reject(h,c,f):e.resolve(h)),a.isFunction(b)&&b.call(d,h,c,f)}function m(b,c){b.src!==g&&-1===a.inArray(b,i)&&(i.push(b),c?k.push(b):j.push(b),a.data(b,"imagesLoaded",{isBroken:c,src:b.src}),f&&e.notifyWith(a(b),[c,h,a(j),a(k)]),h.length===i.length&&(setTimeout(l),h.unbind(".imagesLoaded")))}var d=this,e=a.isFunction(a.Deferred)?a.Deferred():0,f=a.isFunction(e.notify),h=d.find("img").add(d.filter("img")),i=[],j=[],k=[];return a.isPlainObject(b)&&a.each(b,function(a,c){"callback"===a?b=c:e&&e[a](c)}),h.length?h.bind("load.imagesLoaded error.imagesLoaded",function(a){m(a.target,"error"===a.type)}).each(function(b,d){var e=d.src,f=a.data(d,"imagesLoaded");return f&&f.src===e?void m(d,f.isBroken):d.complete&&d.naturalWidth!==c?void m(d,0===d.naturalWidth||0===d.naturalHeight):void((d.readyState||d.complete)&&(d.src=g,d.src=e))}):l(),e?e.promise(d):d};var h=a(b),i=b.Modernizr;a.Stapel=function(b,c){this.el=a(c),this._init(b)},a.Stapel.defaults={gutter:40,pileAngles:2,pileAnimation:{openSpeed:400,openEasing:"ease-in-out",closeSpeed:400,closeEasing:"ease-in-out"},otherPileAnimation:{openSpeed:400,openEasing:"ease-in-out",closeSpeed:350,closeEasing:"ease-in-out"},delay:0,randomAngle:!1,onLoad:function(){return!1},onBeforeOpen:function(){return!1},onAfterOpen:function(){return!1},onBeforeClose:function(){return!1},onAfterClose:function(){return!1}},a.Stapel.prototype={_init:function(b){this.options=a.extend(!0,{},a.Stapel.defaults,b),this._config();var c=this;this.el.imagesLoaded(function(){c.options.onLoad(),c._layout(),c._initEvents()})},_config:function(){this.support=i.csstransitions;var b={WebkitTransition:{transitionEndEvent:"webkitTransitionEnd",tranformName:"-webkit-transform"},MozTransition:{transitionEndEvent:"transitionend",tranformName:"-moz-transform"},OTransition:{transitionEndEvent:"oTransitionEnd",tranformName:"-o-transform"},msTransition:{transitionEndEvent:"MSTransitionEnd",tranformName:"-ms-transform"},transition:{transitionEndEvent:"transitionend",tranformName:"transform"}};this.support&&(this.transEndEventName=b[i.prefixed("transition")].transitionEndEvent+".stapel",this.transformName=b[i.prefixed("transition")].tranformName),this.spread=!1,this.items=this.el.children("li").hide(),this.close=a("#tp-close")},_getSize:function(){this.elWidth=this.el.outerWidth(!0)},_initEvents:function(){var b=this;h.on("debouncedresize.stapel",function(){b._resize()}),this.items.on("click.stapel",function(){var c=a(this);return!b.spread&&c.data("isPile")?(b.spread=!0,b.pileName=c.data("pileName"),b.options.onBeforeOpen(b.pileName),b._openPile(),!1):void 0})},_layout:function(){this._piles(),this.itemSize={width:this.items.outerWidth(!0),height:this.items.outerHeight(!0)},this.items.remove(),this._setInitialStyle(),this.el.css("min-width",this.itemSize.width+this.options.gutter),this._getSize(),this._setItemsPosition(),this.items=this.el.children("li").show(),this.itemsCount=this.items.length},_piles:function(){this.piles={};var b,c=this,d=0;this.items.each(function(){for(var e=a(this),f=e.attr("data-pile")||"nopile-"+e.index(),g=f.split(","),h=0,i=g.length;h<i;++h){var j=a.trim(g[h]);b=c.piles[j],b||(b=c.piles[j]={elements:[],position:{left:0,top:0},index:d},++d);var k=e.clone().get(0);b.elements.push({el:k,finalPosition:{left:0,top:0}}),a(k).appendTo(c.el)}})},_setInitialStyle:function(){for(var b in this.piles)for(var c=this.piles[b],d=0,e=c.elements.length;d<e;++d){var f=a(c.elements[d].el),g={transform:"rotate(0deg)"};if(this._applyInitialTransition(f),d===e-2)g={transform:"rotate("+this.options.pileAngles+"deg)"};else if(d===e-3)g={transform:"rotate(-"+this.options.pileAngles+"deg)"};else if(d!==e-1){var h={visibility:"hidden"};f.css(h).data("extraStyle",h)}else"nopile"!==b.substr(0,6)&&f.data("front",!0).append('<div class="tp-title"><span>'+b+"</span><span>"+e+"</span></div>");f.css(g).data({initialStyle:g,pileName:b,pileCount:e,shadow:f.css("box-shadow"),isPile:"nopile"===b.substr(0,6)?!1:!0})}},_applyInitialTransition:function(a){this.support&&a.css("transition","left 400ms ease-in-out, top 400ms ease-in-out")},_setItemsPosition:function(){var d,e,b=0,c=0,f=0,g=0;for(var h in this.piles){var m,n,i=this.piles[h],j=this.itemSize.width+this.options.gutter,k=0,l=0;b+j<=this.elWidth?(d=b,e=c,b+=j):(0===f&&(f=Math.ceil((this.elWidth-b+this.options.gutter)/2)),c+=this.itemSize.height+this.options.gutter,d=0,e=c,b=j),i.position.left=d,i.position.top=e;for(var o=0,p=i.elements.length;o<p;++o){var q=i.elements[o],r=q.finalPosition;k+j<=this.elWidth?(m=k,n=l,k+=j):(l+=this.itemSize.height+this.options.gutter,m=0,n=l,k=j),r.left=m,r.top=n;var s=a(q.el);h!==this.pileName?s.css({left:i.position.left,top:i.position.top}):(g=q.finalPosition.top,s.css({left:q.finalPosition.left,top:g}))}}g=this.spread?g:c,this.el.css({marginLeft:f,height:g+this.itemSize.height})},_openPile:function(){if(!this.spread)return!1;var b;for(var c in this.piles)for(var d=this.piles[c],e=0,f=0,g=d.elements.length;f<g;++f){var h=d.elements[f],i=a(h.el),j=i.find("img"),k=c===this.pileName?{zIndex:900,visibility:"visible",transition:this.support?"left "+this.options.pileAnimation.openSpeed+"ms "+(g-f-1)*this.options.delay+"ms "+this.options.pileAnimation.openEasing+", top "+this.options.pileAnimation.openSpeed+"ms "+(g-f-1)*this.options.delay+"ms "+this.options.pileAnimation.openEasing+", "+this.transformName+" "+this.options.pileAnimation.openSpeed+"ms "+(g-f-1)*this.options.delay+"ms "+this.options.pileAnimation.openEasing:"none"}:{zIndex:1,transition:this.support?"opacity "+this.options.otherPileAnimation.closeSpeed+"ms "+this.options.otherPileAnimation.closeEasing:"none"};c===this.pileName?(i.data("front")&&i.find("div.tp-title").hide(),f<g-1&&j.css("visibility","visible"),b=h.finalPosition,b.transform=this.options.randomAngle&&f!==d.index?"rotate("+Math.floor(11*Math.random()-5)+"deg)":"none",this.support||i.css("transform","none"),f<g-3&&i.css("box-shadow","none")):f<g-1&&j.css("visibility","hidden"),i.css(k);var l=this;c===this.pileName?this._applyTransition(i,b,this.options.pileAnimation.openSpeed,function(){var c=this.target||this.nodeName;if("LI"===c){var d=a(this);d.css("box-shadow",d.data("shadow")),l.support&&d.off(l.transEndEventName),++e,e===d.data("pileCount")&&(a(document).one("mousemove.stapel",function(){l.el.addClass("tp-open")}),l.options.onAfterOpen(l.pileName,e))}}):this._applyTransition(i,{opacity:0},this.options.otherPileAnimation.closeSpeed)}this.el.css("height",b.top+this.itemSize.height)},_closePile:function(){var b=this;if(this.spread){this.spread=!1,this.options.onBeforeClose(this.pileName),this.el.removeClass("tp-open");var c;for(var d in this.piles)for(var e=this.piles[d],f=0,g=0,h=e.elements.length;g<h;++g){var i=a(e.elements[g].el),j=d===this.pileName?{transition:this.support?"left "+this.options.pileAnimation.closeSpeed+"ms "+this.options.pileAnimation.closeEasing+", top "+this.options.pileAnimation.closeSpeed+"ms "+this.options.pileAnimation.closeEasing+", "+this.transformName+" "+this.options.pileAnimation.closeSpeed+"ms "+this.options.pileAnimation.closeEasing:"none"}:{transition:this.support?"opacity "+this.options.otherPileAnimation.openSpeed+"ms "+this.options.otherPileAnimation.openEasing:"none"};i.css(j),c=e.position,d===this.pileName&&(a.extend(c,i.data("initialStyle")),g<h-3&&i.css("box-shadow","none")),d===this.pileName?this._applyTransition(i,c,this.options.pileAnimation.closeSpeed,function(){var d=this.target||this.nodeName;if("LI"===d){var e=a(this),g=e.data("extraStyle");e.css("box-shadow",e.data("shadow")),b.support?(e.off(b.transEndEventName),b._applyInitialTransition(e)):e.css(e.data("initialStyle")),g&&e.css(g),++f,e.data("front")&&e.find("div.tp-title").show(),f===e.data("pileCount")&&b.options.onAfterClose(e.data("pileName"),f)}}):this._applyTransition(i,{opacity:1},this.options.otherPileAnimation.openSpeed,function(){var d=this.target||this.nodeName;if("LI"===d){var e=a(this);e.index()<h-1&&e.find("img").css("visibility","visible"),b.support&&(e.off(b.transEndEventName),b._applyInitialTransition(e))}})}this.pileName="",this.el.css("height",c.top+this.itemSize.height)}return!1},_resize:function(){this._getSize(),this._setItemsPosition()},_applyTransition:function(b,c,d,e){a.fn.applyStyle=this.support?a.fn.css:a.fn.animate,e&&this.support&&b.on(this.transEndEventName,e),e=e||function(){return!1},b.stop().applyStyle(c,a.extend(!0,[],{duration:d+"ms",complete:e}))},closePile:function(){this._closePile()}};var j=function(a){b.console&&b.console.error(a)};a.fn.stapel=function(b){var c=a.data(this,"stapel");if("string"===typeof b){var d=Array.prototype.slice.call(arguments,1);this.each(function(){return c?a.isFunction(c[b])&&"_"!==b.charAt(0)?void c[b].apply(c,d):void j("no such method '"+b+"' for stapel instance"):void j("cannot call methods on stapel prior to initialization; attempted to call method '"+b+"'")})}else this.each(function(){c?c._init():c=a.data(this,"stapel",new a.Stapel(b,this))});return c}}(jQuery,window);